#-----------------------------------------------------------------------------#
#                                  MAKEFILE                                   #
#-----------------------------------------------------------------------------#
#--- Project    : <project title>                                             #
#--- Author     : Kelve T. Henrique                                           #
#--- Last update: <date>                                                      #
#-----------------------------------------------------------------------------#
#--- Dependencies:                                                            #
#            * GCC                                                            #
#            *                                                                #
#            *                                                                #
#-----------------------------------------------------------------------------#

#-----------------------------------------------------------------------------#
#                                  USAGE                                      #
#-----------------------------------------------------------------------------#
#          make           .... build the program image                        #
#          make debug     .... build the program image and invoke gdb         #
#          make flash     .... build an flash the application                 #
#          make erase     .... erase the target device                        #
#          make doc       .... run doxygen - output will be in > doc          #
#          make clean     .... remove intermediate and generated files        #
#-----------------------------------------------------------------------------#

#-----------------------------------------------------------------------------#
#                               DIRECTORIES                                   #
#-----------------------------------------------------------------------------#
BIN           = ./bin
SRC           = ./src
INC           = ./inc
DOC           = ./doc
SYS           = ./sys

#-----------------------------------------------------------------------------#
#                                    TOOLS                                    #
#-----------------------------------------------------------------------------#
TERMINAL      = konsole
AS            = as
CC            = gcc
CP            = objcopy
OD            = objdump
DB            = gdb
SIZE          = size
DO            = doxygen

#-----------------------------------------------------------------------------#
#                                  LIBS                                       #
#-----------------------------------------------------------------------------#
LIBS         += -lm

#-----------------------------------------------------------------------------#
#                             SOURCE FILES                                    #
#-----------------------------------------------------------------------------#
SRC_FILES     = $(wildcard $(SRC)/*.c)

#-----------------------------------------------------------------------------#
#                           DIRECTORIES TO INCLUDE                            #
#-----------------------------------------------------------------------------#
INC_DIR       = -I$(INC)

#-----------------------------------------------------------------------------#
#                           LIBRARIES TO INCLUDE                              #
#-----------------------------------------------------------------------------#
LIBS_DIR      = -L$(SYS)

#-----------------------------------------------------------------------------#
#                                 OBJECT FILES                                #
#-----------------------------------------------------------------------------#
OBJS = $(SRC_FILES:.c=.o)

#-----------------------------------------------------------------------------#
#                              COMPILER OPTIONS                               #
#-----------------------------------------------------------------------------#
CFLAGS        = -Wall # all warning about questionable constructions
CFLAGS       += -Wextra # extra warnings not included by -Wall
CFLAGS       += -Wpedantic
CFLAGS       += -Wmissing-prototypes
CFLAGS       += -Wshadow
CFLAGS     += -Wstrict-prototypes
#CFLAGS     += -mcpu=$(CPU)
#CFLAGS     += -O0
#CFLAGS     += -ffunction-sections -fdata-sections -fsigned-char -fstack-usage
CFLAGS      += -fsanitize=undefined #

CFLAGS = $(strip $(CFLAGS))

#------------------------------------------------------------------------------#
#                              BUILD RULES                                     #
#------------------------------------------------------------------------------#
all: server client
.PHONY: all

target1: $(SRC)/target1
	@echo "COMPILING TARGET1 ................................................."
	@echo ""
	$(CC) $(CFLAGS) $(INC_DIR) $< -o $(BIN)/$@
	@echo ""
	@echo "..................................................................."

target2: $(SRC)/target2
	@echo "COMPILING TARGET2 .................................................."
	@echo ""
	$(CC) $(CFLAGS) $(INC_DIR) $< -o $(BIN)/$@
	@echo ""
	@echo "..................................................................."

.PHONY: doc
doc: $(DOC)/Doxyfile
	@echo "GENERATING DOCUMENTATION .........................................."
	@echo ""
	$(DO) $(DOC)/Doxyfile
	@echo ""
	@echo "..................................................................."

#------------------------------------------------------------------------------#
#                             DEBUG RULES                                      #
#------------------------------------------------------------------------------#
.PHONY: debug
debug: $(BIN)/
ifdef SystemRoot
	@call start JLinkGDBServer -Device XMC4500-1024 -if SWD
else
	$(TERMINAL) -e "JLinkGDBServer -Device XMC4500-1024 -if SWD" &
	sleep 1 && $(TERMINAL) -e "telnet localhost 2333" &
endif
	$(GDB) -q $(BIN)/$(TARGET).elf $(GDB_ARGS)



#------------------------------------------------------------------------------#
#                             CLEAN RULES                                      #
#------------------------------------------------------------------------------#
.PHONY: clean
clean:
	@echo "CLEANING DIRECTORIES .............................................."
	@echo ""
	rm -rf $(BIN)/       > /dev/null 2>&1 || true
	rm -rf $(DOC)/html   > /dev/null 2>&1 || true
	rm -rf $(DOC)/latex  > /dev/null 2>&1 || true
	@echo ""
	@echo "..................................................................."
